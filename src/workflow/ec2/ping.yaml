title: Can't ping EC2 instance from the Internet.
data:
  instanceId: ''
  securityGroupIds: []
  vpcId: ''
  subnetId: ''
input:
  - label: Instance ID
    placeholder: i-01234567891234567
    store: instanceId
steps:
  - name: Retrieve instance info, check public IP.
    js: |
      let res;
      try {
        res = await $.aws.ec2.send(
          new $.ec2.DescribeInstancesCommand({ InstanceIds: [$.data.instanceId] })
        );
      } catch (e) {
        $.err = e;
        return;
      }

      let publicIps = $.jp.query(res, "$..PrivateIpAddresses..PublicIp");
      if (publicIps.length === 0) {
        $.err = "No public IP is associated to this instance.";
        return;
      }
      $.ok += `Public IP address: ${publicIps.join(", ")}. `;

      $.data.securityGroupIds = $.jp.query(res, "$..SecurityGroups[*].GroupId");
      $.data.vpcId = $.jp.query(res, "$..VpcId")[0];
      $.data.subnetId = $.jp.query(res, "$..SubnetId")[0];

      if ($.data.securityGroupIds.length !== 0) {
        $.ok += `Security groups: ${$.data.securityGroupIds.join(", ")}. `;
      } else {
        $.err +=
          "No security groups associated with this instance, which is abnormal. ";
      }
      if ($.data.vpcId && $.data.subnetId) {
        $.ok += `VPC=${$.data.vpcId}, subnet=${$.data.subnetId}. `;
      } else {
        $.err += "Failed to retrieve VPC id and subnet id. ";
      }
  - name: Check security group inbound rules.
    js: |-
      let res;
      try {
        res = await $.aws.ec2.send(
          new $.ec2.DescribeSecurityGroupsCommand({
            GroupIds: $.data.securityGroupIds,
          })
        );
      } catch (e) {
        $.err = e;
        return;
      }

      // check `all traffic`
      let maybeAllowAll = false;
      let anyTrafficCidr = $.jp.query(
        res,
        "$..IpPermissions[?(@.IpProtocol=='-1')]..CidrIp"
      );
      if (anyTrafficCidr.length !== 0) {
        if (anyTrafficCidr.indexOf("0.0.0.0/0" != -1)) {
          $.ok =
            "The security group's inbound rules allow all traffic from 0.0.0.0/0.";
          return;
        } else {
          // not sure if it's ok, need more information
          $.info += `All traffic from those CIDRs are allowed to access this instance: ${anyTrafficCidr.join(
            ", "
          )}. `;
          maybeAllowAll = true;
        }
      }

      // check `all icmp` or `icmp echo request`
      let pingCidr = $.jp.query(
        res,
        // allow echo request, or allow all icmp
        "$..IpPermissions[?(@.IpProtocol=='icmp' && (@.FromPort==8 || @.FromPort==-1))]..CidrIp"
      );
      if (pingCidr.length === 0) {
        if (!maybeAllowAll) {
          $.err +=
            "No IP is allowed to ping this instance, please fix your security group inbound rules. ";
        }
      } else if (pingCidr.indexOf("0.0.0.0/0") != -1) {
        $.ok = "The security group's inbound rules allow ping from 0.0.0.0/0";
      } else {
        // not sure if it's ok, need more information
        $.info += `Those CIDRs are allowed to ping your instance: ${pingCidr.join(
          ", "
        )}. `;
      }
  - name: Check security group outbound rules.
    js: |
      let res;
      try {
        res = await $.aws.ec2.send(
          new $.ec2.DescribeSecurityGroupsCommand({
            GroupIds: $.data.securityGroupIds,
          })
        );
      } catch (e) {
        $.err = e;
        return;
      }

      // check `all traffic`
      let anyTrafficCidr = $.jp.query(
        res,
        "$..IpPermissionsEgress[?(@.IpProtocol=='-1')]..CidrIp"
      );
      let maybeAllowAll = false;
      if (anyTrafficCidr.length !== 0) {
        if (anyTrafficCidr.indexOf("0.0.0.0/0") != -1) {
          $.ok =
            "The security group's outbound rules allow all traffic to 0.0.0.0/0.";
          return;
        } else {
          $.info += `All traffic to those CIDRs are allowed to access this instance: ${anyTrafficCidr.join(
            ", "
          )}. `;
          maybeAllowAll = true;
        }
      }

      // check `all icmp` or `icmp echo reply`
      let pingCidr = $.jp.query(
        res,
        // allow echo reply, or allow all icmp
        "$..IpPermissionsEgress[?(@.IpProtocol=='icmp' && (@.FromPort==0 || @.FromPort==-1))]..CidrIp"
      );
      if (pingCidr.length === 0) {
        if (!maybeAllowAll) {
          $.err =
            "No IP is allowed to ping this instance, please fix your security group outbound rules.";
        }
      } else if (pingCidr.indexOf("0.0.0.0/0") != -1) {
        $.ok += "The security group's outbound rules allow ping to 0.0.0.0/0. ";
      } else {
        $.info += `Those CIDRs are allowed to ping your instance: ${pingCidr.join(
          ", "
        )}. `;
      }
  - name: Check route table.
    js: |
      let routeTableId;
      let igwCidr;
      try {
        let res;
        // find route table by subnet id
        res = await $.aws.ec2.send(
          new $.ec2.DescribeRouteTablesCommand({
            Filters: [{ Name: "association.subnet-id", Values: [$.data.subnetId] }],
          })
        );
        if (res.RouteTables.length !== 0) {
          // explicitly associated a route table
          routeTableId = res.RouteTables[0].RouteTableId;
          igwCidr = $.jp.query(
            res,
            "$..Routes[?(@.GatewayId.startsWith('igw-'))].DestinationCidrBlock"
          );
        } else {
          // use VPC main route table
          res = await $.aws.ec2.send(
            new $.ec2.DescribeRouteTablesCommand({
              Filters: [{ Name: "vpc-id", Values: [$.data.vpcId] }],
            })
          );
          routeTableId = $.jp.query(res, "$..Associations[?(@.Main)].RouteTableId");
          igwCidr = $.jp.query(
            res,
            `$..RouteTables[?(@.RouteTableId=='${routeTableId}')].Routes[?(@.GatewayId.startsWith('igw-'))].DestinationCidrBlock`
          );
        }
      } catch (e) {
        $.err = r;
        return;
      }

      if (igwCidr.length !== 0) {
        if (igwCidr.indexOf("0.0.0.0/0") != -1) {
          $.ok = `Route table ${routeTableId} can access internet gateway when destination belongs to 0.0.0.0/0.`;
          return;
        } else {
          $.info += `Route table ${routeTableId} can access internet gateway when destination belongs to ${igwCidr.join(
            ", "
          )}. `;
        }
      } else {
        // no igw route
        $.err = `No route of the route table ${routeTableId} has Internet Gateway as target.`;
        return;
      }
  - name: Check network ACL.
    js: |
      let inboundRules = [];
      let outboundRules = [];
      try {
        let res = await $.aws.ec2.send(
          new $.ec2.DescribeNetworkAclsCommand({
            Filters: [{ Name: "association.subnet-id", Values: [$.data.subnetId] }],
          })
        );
        inboundRules = $.jp.query(res, "$..Entries[?(!@.Egress)]");
        outboundRules = $.jp.query(res, "$..Entries[?(@.Egress)]");
      } catch (e) {
        $.err = e;
        return;
      }

      // sort rules by rule number ascent
      inboundRules.sort((a, b) => a.RuleNumber - b.RuleNumber);
      outboundRules.sort((a, b) => a.RuleNumber - b.RuleNumber);

      if (inboundRules.length === 0) {
        $.err = "No inbound rules found.";
        return;
      }
      if (outboundRules.length === 0) {
        $.err = "No outbound rules found.";
        return;
      }

      // use the first rule
      let rIn = inboundRules[0];
      let rOut = outboundRules[0];
      let inNotModified = false;
      let outNotModified = false;

      if (
        rIn.Protocol == "-1" &&
        rIn.RuleAction == "allow" &&
        rIn.CidrBlock == "0.0.0.0/0"
      ) {
        inNotModified = true;
      }
      if (
        rOut.Protocol == "-1" &&
        rOut.RuleAction == "allow" &&
        rOut.CidrBlock == "0.0.0.0/0"
      ) {
        outNotModified = true;
      }

      if (inNotModified) {
        if (outNotModified) {
          $.ok += "All traffics are allowed. ";
          return;
        } else {
          $.info += `Outbound ACLs are modified. Rules: ${outboundRules}. `;
        }
      } else {
        if (outNotModified) {
          $.info += `Inbound ACLs are modified. Rules: ${inboundRules}. `;
        } else {
          $.info += `Inbound & Outbound ACLs are modified. Inbound rules: ${inboundRules}. Outbound rules: ${outboundRules}. `;
        }
      }
